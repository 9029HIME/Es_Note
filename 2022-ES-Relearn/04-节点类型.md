# 28-Elasticsearch节点类型

1. 主节点：1个ES集群只会有1个，在候选节点中选举产生。
2. 候选节点：通过node.master:true配置，负责关于索引、节点信息、分片信息的相关操作，可以被选举为主节点。
3. 数据节点：通过node.data:true配置，用于存储索引元数据、文档数据，负责文档的相关操作。
4. 协调节点：默认情况下es的节点都是协调节点，用于处理路由请求，搜索、分发索引等功能。一般请求打到某个es节点上时，这个节点就作为协调节点工作。包括知识点TODO说的分页查询，也是通过协调节点的分发查询、结果聚合、排序来处理的。

# 29-Elasticsearch新增文档的过程

![4500fb597e49fca25ccfdfce3af1455](https://user-images.githubusercontent.com/48977889/168808346-89260255-4e09-4117-b888-0087211f3896.jpg)

以下这三个节点都是集合了候选、数据、协调节点功能，其中node1是主节点，假设新增文档操作直接请求到node1节点。

1. node1**作为协调节点**，算出文档数据的id=1。通过**(hash(id)%分片数量)**得到结果=2
2. 于是node1将新增文档请求（带上文档数据）转发到shard2所在节点node3
3. node3得到文档数据后，**作为数据节点**将文档存储在自身的分片内，并且备份到replica2所在的node2。
4. 在保存和备份都完成后，node2和node3共同返回成功给node1，最后node1返回success给调用者。

# 30-Elasticsearch查询文档过程

![24ce32878ed6393c22bc0feb9e4d796](https://user-images.githubusercontent.com/48977889/168808382-a94afade-11e9-4d38-9977-3cf84a704003.jpg)

这个其实和知识点TODO可以串联起来，图示的协调节点只是逻辑概念，毕竟默认情况下所有节点都是协调节点。ES的文档查询只要分为分散和聚集阶段：

1. 分散：根据查询条件、排序条件（默认score desc）、分页条件（默认0,10）将请求分发到所有数据节点上，收到分发请求的节点按照条件查询出结果，返回给协调节点。当然，如果既是协调节点又是数据节点，自己还要参与查询。
2. 聚合：所有数据节点的结果都返回给协调节点，协调节点将结果集进行排序，分页，最终返回给请求方。

# 31-Elasticsearch职责分配

ES集群内的节点都是候选节点、数据节点、协调节点集一身。但是操作索引、操作文档、查询聚合等本身是占用大量CPU、内存、IO资源的操作，当1个节点充当3个角色会导致单节点的访问压力过大，为了避免这个问题，节点职责分离是有必要的。特别是集群内分片数量很多的情况下，协调节点的聚合压力会很大，此时让它再担当数据节点和候选节点，不利于集群的健康和业务的稳定，一个合理的ES集群的职责划分应该是单一职责的，比如这样：

![ea1bd420d5077340c48ccef2627742c](https://user-images.githubusercontent.com/48977889/168808508-89298f71-cdae-46f5-8564-4b5ae89412c2.jpg)

