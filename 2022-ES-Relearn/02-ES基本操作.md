# 索引操作

## 6-Mapping属性

知识点2可以得知，Mapping和MySQL的Schema概念相通，都是用来约束字段的，那么mapping有以下常见属性：

### type：字段属性

1. 字符串：text、keyword。text可以被分词存储到倒排索引，keyword只能被整个存储。
2. 数值：long,integer,short,byte,double,float。
3. 布尔：boolean
4. 日期：date
5. 对象：object

对于es来说，没有显示声明数组类型，字段属性可以代表数组类型的泛型，比如arr字段的属性是integer，它既可以代表一个整型，又能代表一个整型数组。

### index：这个字段是否创建倒排索引，默认为true

并非所有字段都需要参与搜索，可以避免冗余的倒排索引被创建，从而减少空间损耗。

### analyzer：这个字段使用哪个分词器

一般text类型的字段才需要使用分词器。

### properties：对象属性的子属性

## 7-修改索引

实际上，ES是不支持修改索引的，不管是修改索引名，还是修改其中的mapping属性，它都不能像MySQL那样直接改。但是可以新增字段：

```
PUT /索引名/_mapping
{
	"properties":{
		"新字段1":{
		
		},
		"新字段2":{
		
		}
	}
}
```

**虽然不能直接改，但是可以新建一个索引，将旧索引的数据迁移到新索引那，最后删除旧索引。**

## 8-通过代码新建索引

以导入的项目为例，新建hotel索引：

```
PUT /hotel
{
	"mappings":{
		"properties":{
			"id":{
				"type":"keyword"
			},
			"name":{
				"type":"text",	#酒店名用分词搜索，很正常
				"analyzer":"ik_max_word",
				"copy_to":"brandAndName"
			},
			"address":{
				"type":"text",	
				"analyzer":"ik_max_word"
			},
			"price":{
				"type":"double"
			},
			"score":{
				"type":"double"
			},
			"brand":{
				"type":"keyword", #对于酒店品牌来说，不需要分词
				"copy_to":"brandAndName"
			},
			"city":{
				"type":"keyword" #城市来说，不需要分词
			},
			"starName":{
				"type":"keyword" #对于酒店星级来说，不需要分词
			},
			"business":{
				"type":"text" #对于商区来说，可以分词
			},
			"location":{
				"type":"geo_point" #这是es特有的数据类型，以"纬度,精度"形式的字符串表示经纬度
			},
			"brandAndName":{	#es特有的数据类型，可以聚合多个字段的倒排索引，实现同一条件查询多个字段的效果
				"type":"text",
				"analyzer":"ik_max_word"
			}
		}
	}
}
```

值得注意的是：

1. 对不需要分词的属性，可以采用keyword格式，减少存储消耗。
2. geo_point属性是以"纬度,精度"形式的字符串存储，表示经纬度，可以作为es的经纬度函数参数。
3. 可以定义一个字段A（需要生成索引），其他字段B、C使用"copy_to"关联上A。这样，就能使用A一个字段查询出B、C字段符合条件的文档，**不过A只能用来查询，实际查询结果不会返回**。

当然，上面是DSL语句而已，实际需要通过代码来生成，先引入依赖（**注意要手动修改ES版本**）：

```xml
<properties>
        <java.version>1.8</java.version>
        <elasticsearch.version>7.12.1</elasticsearch.version>
</properties>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
</dependency>
```

配置ES连接，这里用Bean方式配置：

```java
@Bean
public RestHighLevelClient restHighLevelClient(){
    return new RestHighLevelClient(
            RestClient.builder(
                    new HttpHost("127.0.0.1",9200,"http")
            )
    );
}
```

创建索引代码：

```java
String createHotelDSL = "{\"mappings\":{\"properties\":{\"id\":{\"type\":\"keyword\"},\"name\":{\"type\":\"text\",\"analyzer\":\"ik_max_word\",\"copy_to\":\"brandAndName\"},\"address\":{\"type\":\"text\",\"analyzer\":\"ik_max_word\"},\"price\":{\"type\":\"double\"},\"score\":{\"type\":\"double\"},\"brand\":{\"type\":\"keyword\",\"copy_to\":\"brandAndName\"},\"city\":{\"type\":\"keyword\"},\"starName\":{\"type\":\"keyword\"},\"business\":{\"type\":\"text\"},\"location\":{\"type\":\"geo_point\"},\"brandAndName\":{\"type\":\"text\",\"analyzer\":\"ik_max_word\"}}}}";

@Test
public void testCreateIndex() throws IOException {
    String indexName = "hotel";
    CreateIndexRequest createIndexRequest = new CreateIndexRequest(indexName);
    createIndexRequest.source(createHotelDSL, XContentType.JSON);
    restHighLevelClient.indices().create(createIndexRequest, RequestOptions.DEFAULT);
}
```

将创建索引DSL语句的JSON部分作为参数，用来创建索引。

此时在Kibana GET /hotel，就能看到创建好的索引信息：

```json
{
  "hotel" : {
    "aliases" : { },
    "mappings" : {
      "properties" : {
        "address" : {
          "type" : "text",
          "analyzer" : "ik_max_word"
        },
        "brand" : {
          "type" : "keyword",
          "copy_to" : [
            "brandAndName"
          ]
        },
        "brandAndName" : {
          "type" : "text",
          "analyzer" : "ik_max_word"
        },
        "business" : {
          "type" : "text"
        },
        "city" : {
          "type" : "keyword"
        },
        "id" : {
          "type" : "keyword"
        },
        "location" : {
          "type" : "geo_point"
        },
        "name" : {
          "type" : "text",
          "copy_to" : [
            "brandAndName"
          ],
          "analyzer" : "ik_max_word"
        },
        "price" : {
          "type" : "double"
        },
        "score" : {
          "type" : "double"
        },
        "starName" : {
          "type" : "keyword"
        }
      }
    },
    "settings" : {
      "index" : {
        "routing" : {
          "allocation" : {
            "include" : {
              "_tier_preference" : "data_content"
            }
          }
        },
        "number_of_shards" : "1",
        "provided_name" : "hotel",
        "creation_date" : "1652102539922",
        "number_of_replicas" : "1",
        "uuid" : "GOtJiOIbQAWdYcbKgM4sRQ",
        "version" : {
          "created" : "7120199"
        }
      }
    }
  }
}

```

# 文档操作

## 9-新增文档

由于hotel在ES里的经纬度是通过location来定位的，它是latitude和longitude两个字段的整合，因此需要新建一个HotelEsDTO，并且定义一个返回实例的方法：

```java
public class HotelEsDTO {
    private HotelEsDTO(){}
    
    private Long id;
    private String name;
    private String address;
    private String price;
    private String score;
    private String brand;
    private String city;
    private String starName;
    private String business;
    private String location;
    private String pic;


    public static HotelEsDTO getEsDto(Hotel hotel){
        HotelEsDTO esDTO = new HotelEsDTO();
        esDTO.setName(hotel.getName());
        esDTO.setAddress(hotel.getAddress());
        esDTO.setPrice(hotel.getPrice());
        esDTO.setScore(hotel.getScore());
        esDTO.setId(hotel.getId());
        esDTO.setBrand(hotel.getBrand());
        esDTO.setCity(hotel.getCity());
        esDTO.setStarName(hotel.getStarName());
        esDTO.setBusiness(hotel.getBusiness());
        esDTO.setLocation(String.format("%s,%s",hotel.getLatitude(), hotel.getLongitude()));
        esDTO.setId(hotel.getId());
        return esDTO;
    }
```

```java
@Test
public void testCreateDocument() throws IOException {
    Hotel hotel = hotelMapper.selectById(38665L);
    HotelEsDTO esDto = HotelEsDTO.getEsDto(hotel);
    String indexName = "hotel";

    IndexRequest request = new IndexRequest(indexName).id(String.valueOf(esDto));
    request.source(JSONObject.toJSONString(esDto), XContentType.JSON);
    restHighLevelClient.index(request,RequestOptions.DEFAULT);
}
```

通过BulkRequest将数据库里的所有hotel放到es里：

```java
@Test
public void testBulkInsert() throws IOException {
    List<Hotel> hotels = hotelMapper.selectList(null);
    BulkRequest bulkRequest = new BulkRequest();
    for (Hotel hotel : hotels) {
        HotelEsDTO esDto = HotelEsDTO.getEsDto(hotel);
        bulkRequest.add(new IndexRequest("hotel")
                .id(String.valueOf(esDto.getId()))
                .source(JSONObject.toJSONString(esDto),XContentType.JSON));
    }
    restHighLevelClient.bulk(bulkRequest,RequestOptions.DEFAULT);
}
```

最后通过 GET /hotel/_search可以看到插入结果，**实际上，ES的查询结果都会做分页处理，不会直接显示全部的**：

```json
{
  "took" : 519,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 201,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "36934",
        "_score" : 1.0,
        "_source" : {
          "address" : "静安交通路40号",
          "brand" : "7天酒店",
          "business" : "四川北路商业区",
          "city" : "上海",
          "id" : 36934,
          "location" : "31.251433,121.47522",
          "name" : "7天连锁酒店(上海宝山路地铁站店)",
          "price" : "336",
          "score" : "37",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "38609",
        "_score" : 1.0,
        "_source" : {
          "address" : "广灵二路126号",
          "brand" : "速8",
          "business" : "四川北路商业区",
          "city" : "上海",
          "id" : 38609,
          "location" : "31.282444,121.479385",
          "name" : "速8酒店(上海赤峰路店)",
          "price" : "249",
          "score" : "35",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "38665",
        "_score" : 1.0,
        "_source" : {
          "address" : "兰田路38号",
          "brand" : "速8",
          "business" : "长风公园地区",
          "city" : "上海",
          "id" : 38665,
          "location" : "31.244288,121.422419",
          "name" : "速8酒店上海中山北路兰田路店",
          "price" : "226",
          "score" : "35",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "38812",
        "_score" : 1.0,
        "_source" : {
          "address" : "徐汇龙华西路315弄58号",
          "brand" : "7天酒店",
          "business" : "八万人体育场地区",
          "city" : "上海",
          "id" : 38812,
          "location" : "31.174377,121.442875",
          "name" : "7天连锁酒店(上海漕溪路地铁站店)",
          "price" : "298",
          "score" : "37",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "39106",
        "_score" : 1.0,
        "_source" : {
          "address" : "闵行莘庄镇七莘路299号",
          "brand" : "7天酒店",
          "business" : "莘庄工业区",
          "city" : "上海",
          "id" : 39106,
          "location" : "31.113812,121.375869",
          "name" : "7天连锁酒店（上海莘庄地铁站店）",
          "price" : "348",
          "score" : "41",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "39141",
        "_score" : 1.0,
        "_source" : {
          "address" : "杨浦国权路315号",
          "brand" : "7天酒店",
          "business" : "江湾、五角场商业区",
          "city" : "上海",
          "id" : 39141,
          "location" : "31.290057,121.508804",
          "name" : "7天连锁酒店(上海五角场复旦同济大学店)",
          "price" : "349",
          "score" : "38",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "45845",
        "_score" : 1.0,
        "_source" : {
          "address" : "虹桥路100号",
          "brand" : "万怡",
          "business" : "徐家汇地区",
          "city" : "上海",
          "id" : 45845,
          "location" : "31.192714,121.434717",
          "name" : "上海西藏大厦万怡酒店",
          "price" : "589",
          "score" : "45",
          "starName" : "四钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "45870",
        "_score" : 1.0,
        "_source" : {
          "address" : "新元南路555号",
          "brand" : "豪生",
          "business" : "滴水湖临港地区",
          "city" : "上海",
          "id" : 45870,
          "location" : "30.871729,121.81959",
          "name" : "上海临港豪生大酒店",
          "price" : "896",
          "score" : "45",
          "starName" : "四星级"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "46829",
        "_score" : 1.0,
        "_source" : {
          "address" : "恒丰路338号",
          "brand" : "万怡",
          "business" : "上海火车站地区",
          "city" : "上海",
          "id" : 46829,
          "location" : "31.242977,121.455864",
          "name" : "上海浦西万怡酒店",
          "price" : "726",
          "score" : "46",
          "starName" : "四钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "47066",
        "_score" : 1.0,
        "_source" : {
          "address" : "施新路958号",
          "brand" : "华美达",
          "business" : "浦东机场核心区",
          "city" : "上海",
          "id" : 47066,
          "location" : "31.147989,121.759199",
          "name" : "上海浦东东站华美达酒店",
          "price" : "408",
          "score" : "46",
          "starName" : "四钻"
        }
      }
    ]
  }
}
	
```

## 10-文档查询

基于知识点9，ES里已经有足够的文档用例了，ES的最主要作用还是查，所以查询相关的操作还是比较重要的。

ES的基本DSL查询语法如下：

```
GET /indexName/_search
{
	"query":{
		"查询类型":{
			"查询字段":"查询值"
		}
	}
}
```

其中查询类型包含两种：全文检索、精确查询

全文检索：利用分词器将查询值进行分词，将分词结果匹配倒排索引，从而查出文档，全文索引有两种：

1. match_query：普通的分词查询。
2. multi_match_query：多字段分词查询，其实功能和查询copyto的字段一样，但性能会差点。

精确查询：将查询值直接匹配倒排索引，一般是用来查keyword、数值、日期等

## 11-全文检索

基于知识点10，展开说说全文检索的用法，首先看match_query，比如我要查名称含“上海”和“旅游”的酒店

```
GET /hotel/_search
{
	"query":{
		"match":{
			"name":"上海旅游"
		}
	}
}
```

结果：

```json
{
  "took" : 8,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 82,
      "relation" : "eq"
    },
    "max_score" : 5.0120564,
    "hits" : [
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "1565094427",
        "_score" : 5.0120564,
        "_source" : {
          "address" : "秀浦路3999弄17号",
          "brand" : "万怡",
          "business" : "迪士尼度假区",
          "city" : "上海",
          "id" : 1565094427,
          "location" : "31.132913,121.63464",
          "name" : "上海国际旅游度假区万怡酒店",
          "price" : "713",
          "score" : "45",
          "starName" : "四钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "1584362548",
        "_score" : 3.965483,
        "_source" : {
          "address" : "御青路315-317号",
          "brand" : "如家",
          "business" : "周浦康桥地区",
          "city" : "上海",
          "id" : 1584362548,
          "location" : "31.15719,121.572392",
          "name" : "如家酒店(上海浦东国际旅游度假区御桥地铁站店)",
          "price" : "339",
          "score" : "44",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "339777429",
        "_score" : 1.1531773,
        "_source" : {
          "address" : "菊园新区嘉唐公路66号",
          "brand" : "喜来登",
          "business" : "嘉定新城",
          "city" : "上海",
          "id" : 339777429,
          "location" : "31.394595,121.245773",
          "name" : "上海嘉定喜来登酒店",
          "price" : "1286",
          "score" : "44",
          "starName" : "五钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "46829",
        "_score" : 1.0881513,
        "_source" : {
          "address" : "恒丰路338号",
          "brand" : "万怡",
          "business" : "上海火车站地区",
          "city" : "上海",
          "id" : 46829,
          "location" : "31.242977,121.455864",
          "name" : "上海浦西万怡酒店",
          "price" : "726",
          "score" : "46",
          "starName" : "四钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "60223",
        "_score" : 1.0881513,
        "_source" : {
          "address" : "静安华山路250号",
          "brand" : "希尔顿",
          "business" : "静安寺地区",
          "city" : "上海",
          "id" : 60223,
          "location" : "31.219306,121.445427",
          "name" : "上海希尔顿酒店",
          "price" : "2688",
          "score" : "37",
          "starName" : "五星级"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "1463484295",
        "_score" : 1.0881513,
        "_source" : {
          "address" : "沪南公路2653-2号",
          "brand" : "豪生",
          "business" : "周浦康桥地区",
          "city" : "上海",
          "id" : 1463484295,
          "location" : "31.146478,121.568218",
          "name" : "上海和平豪生酒店",
          "price" : "650",
          "score" : "41",
          "starName" : "四钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "1942992995",
        "_score" : 1.0881513,
        "_source" : {
          "address" : "裕民南路1366号",
          "brand" : "凯悦",
          "business" : "嘉定新城",
          "city" : "上海",
          "id" : 1942992995,
          "location" : "31.352298,121.263314",
          "name" : "上海嘉定凯悦酒店",
          "price" : "758",
          "score" : "46",
          "starName" : "五钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "1996823660",
        "_score" : 1.0881513,
        "_source" : {
          "address" : "紫星路588号3幢",
          "brand" : "万怡",
          "business" : "交大/闵行经济开发区",
          "city" : "上海",
          "id" : 1996823660,
          "location" : "31.02118,121.465186",
          "name" : "上海紫竹万怡酒店",
          "price" : "642",
          "score" : "46",
          "starName" : "四钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "2022598930",
        "_score" : 1.0881513,
        "_source" : {
          "address" : "南奉公路3111弄228号",
          "brand" : "喜来登",
          "business" : "奉贤开发区",
          "city" : "上海",
          "id" : 2022598930,
          "location" : "30.921659,121.575572",
          "name" : "上海宝华喜来登酒店",
          "price" : "2899",
          "score" : "46",
          "starName" : "五钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "56201",
        "_score" : 1.0300674,
        "_source" : {
          "address" : "东方路838号",
          "brand" : "万怡",
          "business" : "浦东陆家嘴金融贸易区",
          "city" : "上海",
          "id" : 56201,
          "location" : "31.226031,121.525801",
          "name" : "上海齐鲁万怡大酒店",
          "price" : "873",
          "score" : "44",
          "starName" : "四星级"
        }
      }
    ]
  }
}

```

这种查询方式和普通的搜索场景很吻合，通过用户输入的内容进行分词，再通过分词匹配符合条件的索引，能更大范围地搜索出用户心意的酒店。

如果使用multi_match的话会稍微不同，这里查询的是name和business包含“上海机场”分词后的结果：

```
GET /hotel/_search
{
	"query":{
		"multi_match":{
			"query":"上海机场",
			"fields":["name","business"]
		}
	}
}
```

```json
{
  "took" : 33,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 98,
      "relation" : "eq"
    },
    "max_score" : 6.7339067,
    "hits" : [
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "46829",
        "_score" : 6.7339067,
        "_source" : {
          "address" : "恒丰路338号",
          "brand" : "万怡",
          "business" : "上海火车站地区",
          "city" : "上海",
          "id" : 46829,
          "location" : "31.242977,121.455864",
          "name" : "上海浦西万怡酒店",
          "price" : "726",
          "score" : "46",
          "starName" : "四钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "5873072",
        "_score" : 6.7339067,
        "_source" : {
          "address" : "闸北芷江西路796号",
          "brand" : "速8",
          "business" : "上海火车站地区",
          "city" : "上海",
          "id" : 5873072,
          "location" : "31.255579,121.452903",
          "name" : "速8酒店（上海火车站北广场店）",
          "price" : "190",
          "score" : "41",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "1931442052",
        "_score" : 5.340714,
        "_source" : {
          "address" : "宝安国际机场地面交通中心（GTC）18号出口",
          "brand" : "凯悦",
          "business" : "宝安机场商圈",
          "city" : "深圳",
          "id" : 1931442052,
          "location" : "22.622498,113.812341",
          "name" : "深圳机场凯悦酒店",
          "price" : "291",
          "score" : "47",
          "starName" : "五钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "47066",
        "_score" : 5.027399,
        "_source" : {
          "address" : "施新路958号",
          "brand" : "华美达",
          "business" : "浦东机场核心区",
          "city" : "上海",
          "id" : 47066,
          "location" : "31.147989,121.759199",
          "name" : "上海浦东东站华美达酒店",
          "price" : "408",
          "score" : "46",
          "starName" : "四钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "608374",
        "_score" : 5.027399,
        "_source" : {
          "address" : "东川公路5863号",
          "brand" : "如家",
          "business" : "浦东机场核心区",
          "city" : "上海",
          "id" : 608374,
          "location" : "31.237662,121.718556",
          "name" : "如家酒店(上海浦东机场龙东大道合庆店)",
          "price" : "160",
          "score" : "45",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "200214437",
        "_score" : 5.027399,
        "_source" : {
          "address" : "浦东机场启航路1100号",
          "brand" : "华美达",
          "business" : "浦东机场核心区",
          "city" : "上海",
          "id" : 200214437,
          "location" : "31.160969,121.799086",
          "name" : "上海浦东机场华美达广场酒店",
          "price" : "600",
          "score" : "45",
          "starName" : "四星级"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "1406627919",
        "_score" : 4.7153473,
        "_source" : {
          "address" : "海德一道88号中洲控股中心A座",
          "brand" : "万豪",
          "business" : "海岸城/后海",
          "city" : "深圳",
          "id" : 1406627919,
          "location" : "22.517293,113.933785",
          "name" : "深圳中洲万豪酒店",
          "price" : "204",
          "score" : "47",
          "starName" : "五钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "1975922994",
        "_score" : 4.7153473,
        "_source" : {
          "address" : "南商路84-6号",
          "brand" : "如家",
          "business" : "海岸城/后海",
          "city" : "深圳",
          "id" : 1975922994,
          "location" : "22.513566,113.9291",
          "name" : "如家酒店·neo(深圳南山海岸城南油地铁站店)",
          "price" : "238",
          "score" : "44",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "2060618247",
        "_score" : 4.7153473,
        "_source" : {
          "address" : "粤海街道后海社区后海第二统建楼商业裙楼第二层B",
          "brand" : "汉庭",
          "business" : "海岸城/后海",
          "city" : "深圳",
          "id" : 2060618247,
          "location" : "22.507276,113.931251",
          "name" : "汉庭酒店(深圳海岸城店)",
          "price" : "562",
          "score" : "49",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "395702",
        "_score" : 4.4994707,
        "_source" : {
          "address" : "首都机场3号航站楼三经路1号",
          "brand" : "希尔顿",
          "business" : "首都机场/新国展地区",
          "city" : "北京",
          "id" : 395702,
          "location" : "40.048969,116.619566",
          "name" : "北京首都机场希尔顿酒店",
          "price" : "222",
          "score" : "46",
          "starName" : "五钻"
        }
      }
    ]
  }
}

```

实际上，一般都是用copyto字段，而不是这种用法。

## 12-精确查询

结合知识点10可以知道，精确查询不会分词后匹配，而是直接拿整个查询条件去匹配倒排索引，寻找合适的文档。主要分term和range两种用法

1. term

```
GET /hotel/_search
{
	"query":{
		"term":{
			"brand":"希尔顿"
		}
	}
}
```

```json
{
  "took" : 4,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 10,
      "relation" : "eq"
    },
    "max_score" : 2.9568925,
    "hits" : [
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "60223",
        "_score" : 2.9568925,
        "_source" : {
          "address" : "静安华山路250号",
          "brand" : "希尔顿",
          "business" : "静安寺地区",
          "city" : "上海",
          "id" : 60223,
          "location" : "31.219306,121.445427",
          "name" : "上海希尔顿酒店",
          "price" : "2688",
          "score" : "37",
          "starName" : "五星级"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "60922",
        "_score" : 2.9568925,
        "_source" : {
          "address" : "红松东路1116号",
          "brand" : "希尔顿",
          "business" : "虹桥地区",
          "city" : "上海",
          "id" : 60922,
          "location" : "31.18746,121.395312",
          "name" : "上海虹桥祥源希尔顿酒店",
          "price" : "1108",
          "score" : "45",
          "starName" : "五钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "309208",
        "_score" : 2.9568925,
        "_source" : {
          "address" : "王府井东街8号",
          "brand" : "希尔顿",
          "business" : "天安门/王府井地区",
          "city" : "北京",
          "id" : 309208,
          "location" : "39.914539,116.413392",
          "name" : "北京王府井希尔顿酒店",
          "price" : "1679",
          "score" : "46",
          "starName" : "五钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "395434",
        "_score" : 2.9568925,
        "_source" : {
          "address" : "东三环北路东方路1号",
          "brand" : "希尔顿",
          "business" : "燕莎/朝阳公园商业区",
          "city" : "北京",
          "id" : 395434,
          "location" : "39.952703,116.462387",
          "name" : "北京希尔顿酒店",
          "price" : "350",
          "score" : "45",
          "starName" : "五星级"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "395702",
        "_score" : 2.9568925,
        "_source" : {
          "address" : "首都机场3号航站楼三经路1号",
          "brand" : "希尔顿",
          "business" : "首都机场/新国展地区",
          "city" : "北京",
          "id" : 395702,
          "location" : "40.048969,116.619566",
          "name" : "北京首都机场希尔顿酒店",
          "price" : "222",
          "score" : "46",
          "starName" : "五钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "2351601",
        "_score" : 2.9568925,
        "_source" : {
          "address" : "望海路1177号",
          "brand" : "希尔顿",
          "business" : "深圳湾口岸/蛇口",
          "city" : "深圳",
          "id" : 2351601,
          "location" : "22.479373,113.916013",
          "name" : "深圳蛇口希尔顿南海酒店",
          "price" : "509",
          "score" : "47",
          "starName" : "五钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "368701368",
        "_score" : 2.9568925,
        "_source" : {
          "address" : "福田深南大道1003号",
          "brand" : "希尔顿",
          "business" : "会展中心/CBD",
          "city" : "深圳",
          "id" : 368701368,
          "location" : "22.539313,114.069763",
          "name" : "深圳大中华希尔顿酒店",
          "price" : "1666",
          "score" : "46",
          "starName" : "五钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "2048042240",
        "_score" : 2.9568925,
        "_source" : {
          "address" : "高米店南里18号楼",
          "brand" : "希尔顿",
          "business" : "大兴北京新机场地区",
          "city" : "北京",
          "id" : 2048042240,
          "location" : "39.76875,116.339199",
          "name" : "北京大兴希尔顿酒店",
          "price" : "1283",
          "score" : "48",
          "starName" : "五钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "2056105938",
        "_score" : 2.9568925,
        "_source" : {
          "address" : "新华东街289号2号楼",
          "brand" : "希尔顿",
          "business" : "果园环岛/通州区",
          "city" : "北京",
          "id" : 2056105938,
          "location" : "39.908805,116.659748",
          "name" : "北京通州北投希尔顿酒店",
          "price" : "1068",
          "score" : "48",
          "starName" : "五钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "2062643512",
        "_score" : 2.9568925,
        "_source" : {
          "address" : "展丰路80号",
          "brand" : "希尔顿",
          "business" : "深圳国际会展中心商圈",
          "city" : "深圳",
          "id" : 2062643512,
          "location" : "22.705335,113.77794",
          "name" : "深圳国际会展中心希尔顿酒店",
          "price" : "285",
          "score" : "46",
          "starName" : "五钻"
        }
      }
    ]
  }
}

```

如果使用希尔顿上海，是搜索不出来的，因为没有一个叫"希尔顿上海"的酒店品牌：

```
GET /hotel/_search
{
	"query":{
		"term":{
			"brand":"希尔顿上海"
		}
	}
}
```

```json
{
  "took" : 1,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 0,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  }
}

```

2. range：

```
GET /hotel/_search
{
	"query":{
		"range":{
			"price":{
				"gte":"100",
				"lte":"300"
			}
		}
	}
}
```

```json
{
  "took" : 6,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 50,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "38609",
        "_score" : 1.0,
        "_source" : {
          "address" : "广灵二路126号",
          "brand" : "速8",
          "business" : "四川北路商业区",
          "city" : "上海",
          "id" : 38609,
          "location" : "31.282444,121.479385",
          "name" : "速8酒店(上海赤峰路店)",
          "price" : "249",
          "score" : "35",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "38665",
        "_score" : 1.0,
        "_source" : {
          "address" : "兰田路38号",
          "brand" : "速8",
          "business" : "长风公园地区",
          "city" : "上海",
          "id" : 38665,
          "location" : "31.244288,121.422419",
          "name" : "速8酒店上海中山北路兰田路店",
          "price" : "226",
          "score" : "35",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "38812",
        "_score" : 1.0,
        "_source" : {
          "address" : "徐汇龙华西路315弄58号",
          "brand" : "7天酒店",
          "business" : "八万人体育场地区",
          "city" : "上海",
          "id" : 38812,
          "location" : "31.174377,121.442875",
          "name" : "7天连锁酒店(上海漕溪路地铁站店)",
          "price" : "298",
          "score" : "37",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "395702",
        "_score" : 1.0,
        "_source" : {
          "address" : "首都机场3号航站楼三经路1号",
          "brand" : "希尔顿",
          "business" : "首都机场/新国展地区",
          "city" : "北京",
          "id" : 395702,
          "location" : "40.048969,116.619566",
          "name" : "北京首都机场希尔顿酒店",
          "price" : "222",
          "score" : "46",
          "starName" : "五钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "415600",
        "_score" : 1.0,
        "_source" : {
          "address" : "三间房乡褡裢坡村青年沟西侧558号",
          "brand" : "如家",
          "business" : "传媒大学/管庄地区",
          "city" : "北京",
          "id" : 415600,
          "location" : "39.923212,116.560023",
          "name" : "如家酒店(北京朝阳北路传媒大学褡裢坡地铁站店)",
          "price" : "259",
          "score" : "47",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "416121",
        "_score" : 1.0,
        "_source" : {
          "address" : "莲花池东路120-2号6层",
          "brand" : "如家",
          "business" : "北京西站/丽泽商务区",
          "city" : "北京",
          "id" : 416121,
          "location" : "39.896449,116.317382",
          "name" : "如家酒店(北京西客站北广场店)",
          "price" : "275",
          "score" : "43",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "432335",
        "_score" : 1.0,
        "_source" : {
          "address" : "唐山路145号",
          "brand" : "7天酒店",
          "business" : "北外滩地区",
          "city" : "上海",
          "id" : 432335,
          "location" : "31.252585,121.498753",
          "name" : "7天连锁酒店(上海北外滩国际客运中心地铁站店)",
          "price" : "249",
          "score" : "35",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "485775",
        "_score" : 1.0,
        "_source" : {
          "address" : "吴泾镇宝秀路977号",
          "brand" : "如家",
          "business" : "交大/闵行经济开发区",
          "city" : "上海",
          "id" : 485775,
          "location" : "31.047135,121.46224",
          "name" : "如家酒店(上海闵行华东师范大学吴泾店)",
          "price" : "161",
          "score" : "45",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "517915",
        "_score" : 1.0,
        "_source" : {
          "address" : "布吉路1036号",
          "brand" : "如家",
          "business" : "田贝/水贝珠宝城",
          "city" : "深圳",
          "id" : 517915,
          "location" : "22.583191,114.118499",
          "name" : "如家酒店·neo(深圳草埔地铁站店)",
          "price" : "159",
          "score" : "44",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "541619",
        "_score" : 1.0,
        "_source" : {
          "address" : "莘庄镇莘浜路172号",
          "brand" : "如家",
          "business" : "莘庄工业区",
          "city" : "上海",
          "id" : 541619,
          "location" : "31.105797,121.37755",
          "name" : "如家酒店(上海莘庄地铁站龙之梦商业广场店)",
          "price" : "149",
          "score" : "44",
          "starName" : "二钻"
        }
      }
    ]
  }
}

```

14-地理查询

除了11、12的普通查询外，ES还提供了一些特别函数供我们查询，比如地理查询，地理查询基于location类型的字段，如查询距离[31.21,121.5]这个坐标方圆3公里内的酒店，它会根据坐标和3公里，自动匹配索引内符合location类型字段条件的文档：

```
GET /hotel/_search
{
	"query":{
		"geo_distance":{
			"distance":"3km",
			"location":"31.21,121.5"
		}
	}
}
```

```json
{
  "took" : 10,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 5,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "60214",
        "_score" : 1.0,
        "_source" : {
          "address" : "世纪大道88号（54楼办理入住）",
          "brand" : "君悦",
          "business" : "浦东陆家嘴金融贸易区",
          "city" : "上海",
          "id" : 60214,
          "location" : "31.235152,121.506082",
          "name" : "上海金茂君悦大酒店",
          "price" : "699",
          "score" : "46",
          "starName" : "五星级"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "434082",
        "_score" : 1.0,
        "_source" : {
          "address" : "复兴东路260号",
          "brand" : "如家",
          "business" : "豫园地区",
          "city" : "上海",
          "id" : 434082,
          "location" : "31.220706,121.498769",
          "name" : "如家酒店·neo(上海外滩城隍庙小南门地铁站店)",
          "price" : "392",
          "score" : "44",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "200208940",
        "_score" : 1.0,
        "_source" : {
          "address" : "浦建路38号",
          "brand" : "喜来登",
          "business" : "浦东新国际博览中心",
          "city" : "上海",
          "id" : 200208940,
          "location" : "31.208553,121.518552",
          "name" : "上海浦东喜来登由由公寓",
          "price" : "3168",
          "score" : "45",
          "starName" : "五钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "200214715",
        "_score" : 1.0,
        "_source" : {
          "address" : "浦建路38号",
          "brand" : "喜来登",
          "business" : "浦东新国际博览中心",
          "city" : "上海",
          "id" : 200214715,
          "location" : "31.208739,121.518305",
          "name" : "上海浦东喜来登由由大酒店",
          "price" : "2489",
          "score" : "45",
          "starName" : "五星级"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "200214824",
        "_score" : 1.0,
        "_source" : {
          "address" : "崂山路689号",
          "brand" : "7天酒店",
          "business" : "浦东陆家嘴金融贸易区",
          "city" : "上海",
          "id" : 200214824,
          "location" : "31.220656,121.525127",
          "name" : "7天连锁酒店(上海陆家嘴八佰伴店)",
          "price" : "249",
          "score" : "36",
          "starName" : "二钻"
        }
      }
    ]
  }
}

```

## 13-score是如何算出来的？

ES默认会对每一个查询结果进行评分，最后根据评分由高到低排序结果返回，那么这个评分是根据什么算出来的呢？要了解这个，先要了解什么叫词条频率TF。

词条频率TF指的是(词条出现次数)/(文档中词条总数)，如通过name条件='虹桥如家'分词查询，对于name='虹桥如家酒店真不错'这个文档来说，它可以被分词虹桥、如家、酒店、真、不错，那这个文档的针对'虹桥如家'的词条频率是2/5=0.4，词条频率越高，得分也越高。

早期ES是通过TF-IDF算法，后期就改变为BM25算法，原因是BM25算法不会因为词的重复性而线性增加。

## 14-手动介入score运算

很多时候，我们都不期望使用ES的默认score算法，我们更希望ES在算score的时候能加上人为设定，这时候就要使用Function Socre Query了，基本语法如下：

```
GET /hotel/_search
{
	"query":{
		"function_score":{
			"query":{
				"match":{
					"name":"上海外滩"
				}
			},
			"functions":[
				{
					"filter":{"term":{"id":"1"}},
					"weight":10
				}
			],
			"boost_mode":"multiply"
		}
	}
}
```

一个FSQ，可以被拆分成4个部分，首先是原始查询条件，它可以理解为最原始的查询语句，只不过被放到function_score里了：

```json
"query":{
	"match":{
		"name":"上海外滩"
		}
}
```

其次是过滤条件，即function.filter，**命中这个条件的文档才会参与重新算分**，在这里指的是id=1的文档才需要重新算分：

```json
{
	"filter":{"term":{"id":"1"}}
}
```

接着是算分函数，即function.weight，它代表需要被重新算分的文档**应该怎样算分**，weight的作用是将值直接**函数结果**，除了weight以外，还有其他的算分函数：

1. field_value_factor：指定这个文档的**某个字段值**作为函数结果。
2. random_score：随机生成一个值作为函数结果

最后是加权模式，即boost_mode。function算出函数结果后，通过加权模式将函数结果与原始socre按照特定规则运算，得到最终结果。有以下加权结果：

1. multiply（默认）：函数结果x原始socre。
2. replace：函数结果直接作为score。
3. 常规运算，如sum,avg,max,min。

## 15-复合查询

那很多时候，业务查询肯定不会只限定一个字段，所以就需要提出“复合查询”，复合查询的基本语法：

```
GET /hotel/_search
{
	"query":{
		"bool":{
			"must":[
				
			],
			"should":[
			
			],
			"must_not":[
			
			],
			"filter":[
			
			]
		}
	}
}
```

复合查询是基于bool查询类型来完成的，而bool内又有四种复合查询的方式，分别是：

1. must：must数组内的查询语句必须都符合，属于and。
2. should：should数组内的查询语句只需符合一个，属于or。
3. must_not：must_not数组内的查询语句必须都**不符合**，属于NOT IN。
4. filter：filter数组内的查询语句必须都符合，属于and。
5. 不同复合查询方式之间的呈and的关系。
6. must_not和filter比较特殊，它们所查询的字段都不参与ES的算分，可以将不需要算分的字段放在这，提升性能。

以下是查询“名字包含如家，价格不高于400，坐标在31.21,121.5方圆3km范围内的酒店”的语句：

```
GET /hotel/_search

{
	"query":{
		"bool":{
			"must":[
				{
					"match":{"name":"如家"}
				}
			],
			"must_not":[
				{
					"range":{
						"price":{"gt":400}
					}
				}
			],
			"filter":[{
				"geo_distance":{
					"distance":"3km",
					"location":"31.21,121.5"
				}
			}
			]
		}
	}
}
```

```json
{
  "took" : 8,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 201,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "36934",
        "_score" : 1.0,
        "_source" : {
          "address" : "静安交通路40号",
          "brand" : "7天酒店",
          "business" : "四川北路商业区",
          "city" : "上海",
          "id" : 36934,
          "location" : "31.251433,121.47522",
          "name" : "7天连锁酒店(上海宝山路地铁站店)",
          "price" : "336",
          "score" : "37",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "38609",
        "_score" : 1.0,
        "_source" : {
          "address" : "广灵二路126号",
          "brand" : "速8",
          "business" : "四川北路商业区",
          "city" : "上海",
          "id" : 38609,
          "location" : "31.282444,121.479385",
          "name" : "速8酒店(上海赤峰路店)",
          "price" : "249",
          "score" : "35",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "38665",
        "_score" : 1.0,
        "_source" : {
          "address" : "兰田路38号",
          "brand" : "速8",
          "business" : "长风公园地区",
          "city" : "上海",
          "id" : 38665,
          "location" : "31.244288,121.422419",
          "name" : "速8酒店上海中山北路兰田路店",
          "price" : "226",
          "score" : "35",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "38812",
        "_score" : 1.0,
        "_source" : {
          "address" : "徐汇龙华西路315弄58号",
          "brand" : "7天酒店",
          "business" : "八万人体育场地区",
          "city" : "上海",
          "id" : 38812,
          "location" : "31.174377,121.442875",
          "name" : "7天连锁酒店(上海漕溪路地铁站店)",
          "price" : "298",
          "score" : "37",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "39106",
        "_score" : 1.0,
        "_source" : {
          "address" : "闵行莘庄镇七莘路299号",
          "brand" : "7天酒店",
          "business" : "莘庄工业区",
          "city" : "上海",
          "id" : 39106,
          "location" : "31.113812,121.375869",
          "name" : "7天连锁酒店（上海莘庄地铁站店）",
          "price" : "348",
          "score" : "41",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "39141",
        "_score" : 1.0,
        "_source" : {
          "address" : "杨浦国权路315号",
          "brand" : "7天酒店",
          "business" : "江湾、五角场商业区",
          "city" : "上海",
          "id" : 39141,
          "location" : "31.290057,121.508804",
          "name" : "7天连锁酒店(上海五角场复旦同济大学店)",
          "price" : "349",
          "score" : "38",
          "starName" : "二钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "45845",
        "_score" : 1.0,
        "_source" : {
          "address" : "虹桥路100号",
          "brand" : "万怡",
          "business" : "徐家汇地区",
          "city" : "上海",
          "id" : 45845,
          "location" : "31.192714,121.434717",
          "name" : "上海西藏大厦万怡酒店",
          "price" : "589",
          "score" : "45",
          "starName" : "四钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "45870",
        "_score" : 1.0,
        "_source" : {
          "address" : "新元南路555号",
          "brand" : "豪生",
          "business" : "滴水湖临港地区",
          "city" : "上海",
          "id" : 45870,
          "location" : "30.871729,121.81959",
          "name" : "上海临港豪生大酒店",
          "price" : "896",
          "score" : "45",
          "starName" : "四星级"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "46829",
        "_score" : 1.0,
        "_source" : {
          "address" : "恒丰路338号",
          "brand" : "万怡",
          "business" : "上海火车站地区",
          "city" : "上海",
          "id" : 46829,
          "location" : "31.242977,121.455864",
          "name" : "上海浦西万怡酒店",
          "price" : "726",
          "score" : "46",
          "starName" : "四钻"
        }
      },
      {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "47066",
        "_score" : 1.0,
        "_source" : {
          "address" : "施新路958号",
          "brand" : "华美达",
          "business" : "浦东机场核心区",
          "city" : "上海",
          "id" : 47066,
          "location" : "31.147989,121.759199",
          "name" : "上海浦东东站华美达酒店",
          "price" : "408",
          "score" : "46",
          "starName" : "四钻"
        }
      }
    ]
  }
}

```

## 16-复合查询后介入score运算

突然想到，如果在复合查询后，再重新运算一下score，能否成功呢？我们看到知识点15的查询结果里，排序最后的文档price=408，那么就让price=408的文档排序最优先，TODO 试了好多次，都是不行，可能是语法搭配不太对：

```
GET /hotel/_search
{
    "query":{
        "function_score":{
            "query":{
                "bool":{
                    "must":[
                        {
                            "match":{
                                "name":"如家"
                            }
                        }
                    ],
                    "must_not":[
                        {
                            "range":{
                                "price":{
                                    "gt":400
                                }
                            }
                        }
                    ],
                    "filter":[
                        {
                            "geo_distance":{
                                "distance":"3km",
                                "location":"31.21,121.5"
                            }
                        }
                    ]
                }
            },
            "functions":[
                {
                    "filter":{
                        "term":{
                            "price":"408"
                        }
                    },
                    "weight":10
                }
            ],
            "boost_mode":"multiply"
        }
    }
}
```

