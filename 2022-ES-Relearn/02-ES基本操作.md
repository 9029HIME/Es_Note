# 索引操作

## 6-Mapping属性

知识点2可以得知，Mapping和MySQL的Schema概念相通，都是用来约束字段的，那么mapping有以下常见属性：

### type：字段属性

1. 字符串：text、keyword。text可以被分词存储到倒排索引，keyword只能被整个存储。
2. 数值：long,integer,short,byte,double,float。
3. 布尔：boolean
4. 日期：date
5. 对象：object

对于es来说，没有显示声明数组类型，字段属性可以代表数组类型的泛型，比如arr字段的属性是integer，它既可以代表一个整型，又能代表一个整型数组。

### index：这个字段是否创建倒排索引，默认为true

并非所有字段都需要参与搜索，可以避免冗余的倒排索引被创建，从而减少空间损耗。

### analyzer：这个字段使用哪个分词器

一般text类型的字段才需要使用分词器。

### properties：对象属性的子属性

## 7-修改索引

实际上，ES是不支持修改索引的，不管是修改索引名，还是修改其中的mapping属性，它都不能像MySQL那样直接改。但是可以新增字段：

```
PUT /索引名/_mapping
{
	"properties":{
		"新字段1":{
		
		},
		"新字段2":{
		
		}
	}
}
```

**虽然不能直接改，但是可以新建一个索引，将旧索引的数据迁移到新索引那，最后删除旧索引。**

## 8-通过代码新建索引

以导入的项目为例，新建hotel索引：

```
PUT /hotel
{
	"mappings":{
		"properties":{
			"id":{
				"type":"keyword"
			},
			"name":{
				"type":"text",	#酒店名用分词搜索，很正常
				"analyzer":"ik_max_word",
				"copy_to":"brandAndName"
			},
			"address":{
				"type":"text",	
				"analyzer":"ik_max_word"
			},
			"price":{
				"type":"double"
			},
			"score":{
				"type":"double"
			},
			"brand":{
				"type":"keyword", #对于酒店品牌来说，不需要分词
				"copy_to":"brandAndName"
			},
			"city":{
				"type":"keyword" #城市来说，不需要分词
			},
			"starName":{
				"type":"keyword" #对于酒店星级来说，不需要分词
			},
			"business":{
				"type":"text" #对于商区来说，可以分词
			},
			"location":{
				"type":"geo_point" #这是es特有的数据类型，以"纬度,精度"形式的字符串表示经纬度
			},
			"brandAndName":{	#es特有的数据类型，可以聚合多个字段的倒排索引，实现同一条件查询多个字段的效果
				"type":"text",
				"analyzer":"ik_max_word"
			}
		}
	}
}
```

值得注意的是：

1. 对不需要分词的属性，可以采用keyword格式，减少存储消耗。
2. geo_point属性是以"纬度,精度"形式的字符串存储，表示经纬度，可以作为es的经纬度函数参数。
3. 可以定义一个字段A（需要生成索引），其他字段B、C使用"copy_to"关联上A。这样，就能使用A一个字段查询出B、C字段符合条件的文档，**不过A只能用来查询，实际查询结果不会返回**。

当然，上面是DSL语句而已，实际需要通过代码来生成，先引入依赖（**注意要手动修改ES版本**）：

```xml
<properties>
        <java.version>1.8</java.version>
        <elasticsearch.version>7.12.1</elasticsearch.version>
</properties>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
</dependency>
```

配置ES连接，这里用Bean方式配置：

```java
@Bean
public RestHighLevelClient restHighLevelClient(){
    return new RestHighLevelClient(
            RestClient.builder(
                    new HttpHost("127.0.0.1",9200,"http")
            )
    );
}
```

创建索引代码：

```java
String createHotelDSL = "{\"mappings\":{\"properties\":{\"id\":{\"type\":\"keyword\"},\"name\":{\"type\":\"text\",\"analyzer\":\"ik_max_word\",\"copy_to\":\"brandAndName\"},\"address\":{\"type\":\"text\",\"analyzer\":\"ik_max_word\"},\"price\":{\"type\":\"double\"},\"score\":{\"type\":\"double\"},\"brand\":{\"type\":\"keyword\",\"copy_to\":\"brandAndName\"},\"city\":{\"type\":\"keyword\"},\"starName\":{\"type\":\"keyword\"},\"business\":{\"type\":\"text\"},\"location\":{\"type\":\"geo_point\"},\"brandAndName\":{\"type\":\"text\",\"analyzer\":\"ik_max_word\"}}}}";

@Test
public void testCreateIndex() throws IOException {
    String indexName = "hotel";
    CreateIndexRequest createIndexRequest = new CreateIndexRequest(indexName);
    createIndexRequest.source(createHotelDSL, XContentType.JSON);
    restHighLevelClient.indices().create(createIndexRequest, RequestOptions.DEFAULT);
}
```

将创建索引DSL语句的JSON部分作为参数，用来创建索引。

此时在Kibana GET /hotel，就能看到创建好的索引信息：

```json
{
  "hotel" : {
    "aliases" : { },
    "mappings" : {
      "properties" : {
        "address" : {
          "type" : "text",
          "analyzer" : "ik_max_word"
        },
        "brand" : {
          "type" : "keyword",
          "copy_to" : [
            "brandAndName"
          ]
        },
        "brandAndName" : {
          "type" : "text",
          "analyzer" : "ik_max_word"
        },
        "business" : {
          "type" : "text"
        },
        "city" : {
          "type" : "keyword"
        },
        "id" : {
          "type" : "keyword"
        },
        "location" : {
          "type" : "geo_point"
        },
        "name" : {
          "type" : "text",
          "copy_to" : [
            "brandAndName"
          ],
          "analyzer" : "ik_max_word"
        },
        "price" : {
          "type" : "double"
        },
        "score" : {
          "type" : "double"
        },
        "starName" : {
          "type" : "keyword"
        }
      }
    },
    "settings" : {
      "index" : {
        "routing" : {
          "allocation" : {
            "include" : {
              "_tier_preference" : "data_content"
            }
          }
        },
        "number_of_shards" : "1",
        "provided_name" : "hotel",
        "creation_date" : "1652102539922",
        "number_of_replicas" : "1",
        "uuid" : "GOtJiOIbQAWdYcbKgM4sRQ",
        "version" : {
          "created" : "7120199"
        }
      }
    }
  }
}

```

